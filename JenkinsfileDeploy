def tag = env.TAG_NAME
def version = tag.substring(1)

stage('Test stage') {
    node('master') {
            println("Triggered by tag ${tag}")
    }
}

stage('Deploy Tests') {
    node('dom') {
        sh(returnStatus: true,
           script: """git clone git@github.com:eth-cscs/reframe-tests.git
                      cd reframe-tests
                      git tag -a -m "test tag" -f ${tag}
                      git archive --format=tar.gz --prefix=reframe-tests-${version}/ ${tag} -o reframe-tests-${version}.tar.gz
                      git push origin -f ${tag}
                      cp reframe-tests-${version}.tar.gz /apps/common/easybuild/sources/r/reframe
                      ls -lha""")
            deleteDir()
   }
}
